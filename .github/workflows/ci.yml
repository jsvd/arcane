name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  ts-tests-node:
    name: TypeScript tests (Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - run: ./run-tests.sh

  rust-tests:
    name: Rust tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1-rust
      - name: Install ALSA development libraries
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev
      - run: cargo test --workspace

  ts-tests-v8:
    name: TypeScript tests (V8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1-rust
      - name: Install ALSA development libraries
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev
      - run: npm install
      - run: cargo run -- test

  headless-check:
    name: Headless build (no GPU)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1-rust
      - run: cargo check -p arcane-engine --no-default-features

  declarations-check:
    name: API declarations up-to-date
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - run: npm install
      - run: ./scripts/generate-declarations.sh
      - name: Check for stale declarations
        run: |
          if git diff --exit-code templates/default/types/arcane.d.ts; then
            echo "Declarations are up to date."
          else
            echo "ERROR: templates/default/types/arcane.d.ts is stale."
            echo "Run ./scripts/generate-declarations.sh and commit the result."
            exit 1
          fi

  full-build:
    name: Full build (with renderer + audio)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v1-rust
      - name: Install ALSA development libraries
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev
      - run: cargo check --workspace
