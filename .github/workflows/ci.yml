name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  ts-tests-node:
    name: TypeScript tests (Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - run: ./run-tests.sh

  rust-tests:
    name: Rust tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v2-rust
      - name: Install system dependencies (ALSA + udev)
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev
      - run: cargo test --workspace

  ts-tests-v8:
    name: TypeScript tests (V8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v2-rust
      - name: Install system dependencies (ALSA + udev)
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev
      - run: npm install
      - run: cargo run -- test

  headless-check:
    name: Headless build (no GPU)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v2-rust
      - run: cargo check -p arcane-core --no-default-features

  declarations-check:
    name: API declarations up-to-date
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - run: npm install
      - run: ./scripts/generate-declarations.sh
      - name: Check for stale declarations
        run: |
          if git diff --exit-code templates/default/types/; then
            echo "Declarations are up to date."
          else
            echo "ERROR: templates/default/types/*.d.ts are stale."
            echo "Run ./scripts/generate-declarations.sh and commit the result."
            exit 1
          fi

  full-build:
    name: Full build (with renderer + audio)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v2-rust
      - name: Install system dependencies (ALSA + udev)
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev
      - run: cargo check --workspace

  publish:
    name: Publish to crates.io
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [ts-tests-node, rust-tests, ts-tests-v8, headless-check, declarations-check, full-build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: v2-rust
      - name: Install system dependencies (ALSA + udev)
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev
      - name: Publish arcane-core
        run: cargo publish -p arcane-core || echo "Already published (or error above)"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      - name: Wait for crates.io indexing
        run: sleep 60
      - name: Publish arcane-engine
        run: cargo publish -p arcane-engine --allow-dirty || echo "Already published (or error above)"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
